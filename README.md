概要
=====

これは何？
----------

ドットインストールの [「ユーザー管理をするWebサービスを作ろう」](http://dotinstall.com/lessons/sns_php_v2) を自分の納得のいくようにアレンジしたもの。データベース定義はそっくりそのまま用いている。念のため下記に記載する。

```sql
CREATE DATABASE `dotinstall_sns_php` DEFAULT CHARACTER SET utf8 COLLATE utf8_general_ci;
USE `dotinstall_sns_php`;
CREATE TABLE `users` (
  `id` int(11) NOT NULL AUTO_INCREMENT,
  `name` varchar(255) NOT NULL,
  `email` varchar(255) NOT NULL,
  `password` varchar(255) NOT NULL,
  `created` datetime NOT NULL,
  `modified` datetime NOT NULL,
  PRIMARY KEY (`id`),
  UNIQUE KEY `email` (`email`)
) ENGINE=InnoDB  DEFAULT CHARSET=utf8 AUTO_INCREMENT=4 ;
```

ターゲット層は？
---------------

汚いコードを卒業したい、でもフレームワークまでいくと意味が分からない、と悩む初心者～中級者向け。クラスとオブジェクトがある程度分かっている前提なので、全く分からない人は下記リンク先で予習を。

### [PHP入門 - ポンクソフト](http://ponk.jp/php/basic/)

ここが一番初心者に優しく、且つまともな情報が書いてあるサイトであろうか。

### [PHP入門 - PHPBook](http://www.phpbook.jp/tutorial/)

ここもなかなか分かりやすい方。

### [PHP Manual](http://www.php.net/manual/ja/)

豊富で正確な情報が欲しければここ。但し、マニュアルだからといって全て正しいわけではなく、稀に間違ったこともかかれていたりするので、疑いの目を向けることは大切である。

コンセプトは？
-------------

**フレームワークを使わずにフレームワークっぽいことをする。** もちろんオブジェクト指向的な書き方を中心に。エラー時にバカの一つ覚えみたいに `exit()` `die()` することは避け、エラーページを簡易的にレンダリングする工夫も入れている。

ライセンスは？
------------

**CC0** なので改変なり再頒布なりご自由にどうぞ。

各ファイル説明
==============

init.php
--------

全てのアクションページから最初に読み込まれるファイル。必要な他ファイルの読み込み、セッションの制御などを行っている。

config.php
---------

### `DISPLAY_SQL_STATE` って何？

`True` にするとPDOのエラーメッセージがそのまま表示され、 `False` にすると全て **「データベースでエラーが発生しました。」** に置き換えられる。一般公開するときには後者のほうが望ましい。

Module.php
----------

関数群はここにまとめている。 

### `e` とか `exception_to_array` の **Previous** って何！？

PHPの例外はスタックに積むことが出来る。これを利用して、例えば

- 名前が入力されていません
- メールアドレスが入力されていません

といった例外を、発生してすぐにはスローせずに、 **スタックに積んで最後にまとめてスロー** している。但しこの方法だと、スタックの **「新しいものを先に取り出す」** 性質故に順番が逆になってしまうので、配列に順番に代入させたあと、 `array_reverse` 関数を使って順番を反転させている。

### `filter_struct_utf8` 長すぎて意味わからない！

[リンク先](http://qiita.com/mpyw/items/c39b9ee695a5c2e74627)を見て使い方だけを分かっていただければ問題ない。

DB.php
------

データベース接続に関する処理を全てまとめた **シングルトン** クラス。ドットインストールの例では関数呼び出し側で値のチェックを行っているが、そうするとMVCフレームワークの問題でよく言われる **「コントローラの肥大化」** のような問題が起きて見通しが悪くなるので、そういった処理はクラス内で行うようにしている。 **「例外」** を積極的に利用し、PHP古来の「返り値がFALSEでないか確認する」面倒なスタイルを避けている。

Token.php
---------

CSRF攻撃対策のトークン関連の処理を行うクラス。全て **静的** なコールで呼び出される(インスタンスを必要としない)。ドットインストールの例では1ページを開いているときしか想定していないが、こちらはトークンを10個まで保有するようにしているため、ある程度複数ページを出して作業しても正しく判定できる。

signup.php<br />login.php<br />index.php<br />profile.php<br />logout.php
----------

各ページ。これらに記述するロジックを可能な限り減らしている。

error.php
---------

致命的なエラーが起きたときにここに遷移させる。エラーメッセージは簡易的に `GET` で渡している(本当はあまり望ましくないが)。


とりあえず動かしてみたい！
========================

[Download ZIP](https://github.com/Certainist/sns_php/archive/master.zip) から丸ごと落として、 `config.php` を編集する。あとは `index.php` にアクセスすればうまく動くはず。